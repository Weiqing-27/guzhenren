const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

// åˆ›å»ºSupabaseå®¢æˆ·ç«¯
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function setupDatabase() {
  try {
    console.log('å¼€å§‹è®¾ç½®å®‰éš…APPæ•°æ®åº“...');
    
    // æŒ‰æ­£ç¡®é¡ºåºåˆ›å»ºè¡¨
    const creationSteps = [
      {
        name: 'åˆ†ç±»è¡¨',
        function: 'create_categories_table_step1',
        description: 'åˆ›å»ºcategoriesè¡¨åŠå…¶ç´¢å¼•'
      },
      {
        name: 'è´¦å•è¡¨', 
        function: 'create_bills_table_step2',
        description: 'åˆ›å»ºbillsè¡¨åŠå…¶ç´¢å¼•'
      },
      {
        name: 'æƒ…æ„Ÿäº‹ä»¶è¡¨',
        function: 'create_emotional_events_table_step3',
        description: 'åˆ›å»ºemotional_eventsè¡¨åŠå…¶ç´¢å¼•'
      },
      {
        name: 'è§‚ç‚¹åæ€è¡¨',
        function: 'create_perspectives_table_step4', 
        description: 'åˆ›å»ºperspectivesè¡¨åŠå…¶ç´¢å¼•'
      },
      {
        name: 'é£Ÿè°±è¡¨',
        function: 'create_recipes_table_step5',
        description: 'åˆ›å»ºrecipesè¡¨åŠå…¶ç´¢å¼•'
      },
      {
        name: 'è®¢å•è¡¨',
        function: 'create_orders_table_step6',
        description: 'åˆ›å»ºmeal_ordersè¡¨åŠå…¶ç´¢å¼•'
      }
    ];

    for (const step of creationSteps) {
      console.log(`\n--- æ­£åœ¨åˆ›å»º${step.name} ---`);
      console.log(step.description);
      
      const { error } = await supabase.rpc(step.function);
      
      if (error) {
        console.log(`âš ï¸  ${step.name}åˆ›å»ºå¯èƒ½å·²å­˜åœ¨æˆ–å¤±è´¥:`, error.message);
        // ä¸ä¸­æ–­æµç¨‹ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªè¡¨
      } else {
        console.log(`âœ… ${step.name}åˆ›å»ºæˆåŠŸ`);
      }
    }

    console.log('\nğŸ‰ æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆï¼');
    
    // æ’å…¥é»˜è®¤æ•°æ®
    await insertDefaultData();
    
  } catch (error) {
    console.error('âŒ è®¾ç½®æ•°æ®åº“æ—¶å‘ç”Ÿé”™è¯¯:', error);
  }
}

async function insertDefaultData() {
  try {
    console.log('\n--- æ’å…¥é»˜è®¤æ•°æ® ---');
    
    // æ’å…¥é»˜è®¤åˆ†ç±»æ•°æ®
    const defaultCategories = [
      // æ”¶å…¥åˆ†ç±»
      { name: 'å·¥èµ„', type: 'income', icon: 'salary', color: '#4CAF50', is_default: true },
      { name: 'å¥–é‡‘', type: 'income', icon: 'bonus', color: '#8BC34A', is_default: true },
      { name: 'æŠ•èµ„æ”¶ç›Š', type: 'income', icon: 'investment', color: '#CDDC39', is_default: true },
      { name: 'å…¶ä»–æ”¶å…¥', type: 'income', icon: 'other-income', color: '#FFEB3B', is_default: true },
      // æ”¯å‡ºåˆ†ç±»
      { name: 'é¤é¥®', type: 'outcome', icon: 'food', color: '#F44336', is_default: true },
      { name: 'äº¤é€š', type: 'outcome', icon: 'transport', color: '#E91E63', is_default: true },
      { name: 'è´­ç‰©', type: 'outcome', icon: 'shopping', color: '#9C27B0', is_default: true },
      { name: 'å¨±ä¹', type: 'outcome', icon: 'entertainment', color: '#673AB7', is_default: true },
      { name: 'ä½æˆ¿', type: 'outcome', icon: 'housing', color: '#3F51B5', is_default: true },
      { name: 'åŒ»ç–—', type: 'outcome', icon: 'medical', color: '#2196F3', is_default: true },
      { name: 'æ•™è‚²', type: 'outcome', icon: 'education', color: '#03A9F4', is_default: true },
      { name: 'å…¶ä»–æ”¯å‡º', type: 'outcome', icon: 'other-outcome', color: '#00BCD4', is_default: true }
    ];

    const { error: categoryError } = await supabase
      .from('categories')
      .insert(defaultCategories);

    if (categoryError) {
      console.log('â„¹ï¸  é»˜è®¤åˆ†ç±»å¯èƒ½å·²å­˜åœ¨:', categoryError.message);
    } else {
      console.log('âœ… é»˜è®¤åˆ†ç±»æ’å…¥æˆåŠŸ');
    }

    console.log('âœ… é»˜è®¤æ•°æ®æ’å…¥å®Œæˆï¼');
  } catch (error) {
    console.error('âŒ æ’å…¥é»˜è®¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
  }
}

// å®šä¹‰åˆ›å»ºè¡¨çš„RPCå‡½æ•°ï¼ˆåˆ†æ­¥æ‰§è¡Œï¼‰
async function defineRpcFunctions() {
  try {
    console.log('å®šä¹‰RPCå‡½æ•°...');
    
    // æ­¥éª¤1: åˆ›å»ºåˆ†ç±»è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_categories_table_step1',
      body: `
        -- åˆ›å»ºåˆ†ç±»è¡¨ï¼ˆä½¿ç”¨æ˜ç¡®çš„INTEGERç±»å‹ï¼‰
        CREATE TABLE IF NOT EXISTS categories (
          id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          name VARCHAR(50) NOT NULL,
          type VARCHAR(10) NOT NULL CHECK (type IN ('income', 'outcome')),
          icon VARCHAR(50),
          color VARCHAR(7) DEFAULT '#000000',
          is_default BOOLEAN DEFAULT FALSE,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºåˆ†ç±»è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_categories_user_id ON categories(user_id);
        CREATE INDEX IF NOT EXISTS idx_categories_type ON categories(type);
        
        RAISE NOTICE 'åˆ†ç±»è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    // æ­¥éª¤2: åˆ›å»ºè´¦å•è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_bills_table_step2',
      body: `
        -- åˆ›å»ºè´¦å•è¡¨
        CREATE TABLE IF NOT EXISTS bills (
          id SERIAL PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          amount DECIMAL(10,2) NOT NULL,
          type VARCHAR(10) NOT NULL CHECK (type IN ('income', 'outcome')),
          category_id INTEGER REFERENCES categories(id) ON DELETE SET NULL,
          description TEXT,
          date DATE NOT NULL DEFAULT CURRENT_DATE,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºè´¦å•è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_bills_user_id ON bills(user_id);
        CREATE INDEX IF NOT EXISTS idx_bills_date ON bills(date);
        CREATE INDEX IF NOT EXISTS idx_bills_type ON bills(type);
        CREATE INDEX IF NOT EXISTS idx_bills_category_id ON bills(category_id);
        
        RAISE NOTICE 'è´¦å•è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    // æ­¥éª¤3: åˆ›å»ºæƒ…æ„Ÿäº‹ä»¶è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_emotional_events_table_step3',
      body: `
        -- åˆ›å»ºæƒ…æ„Ÿäº‹ä»¶è¡¨
        CREATE TABLE IF NOT EXISTS emotional_events (
          id SERIAL PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          title VARCHAR(200) NOT NULL,
          content TEXT,
          mood VARCHAR(20) NOT NULL CHECK (mood IN ('happy', 'sad', 'angry', 'neutral', 'excited', 'anxious')),
          date DATE NOT NULL DEFAULT CURRENT_DATE,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºæƒ…æ„Ÿäº‹ä»¶è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_emotional_events_user_id ON emotional_events(user_id);
        CREATE INDEX IF NOT EXISTS idx_emotional_events_date ON emotional_events(date);
        
        RAISE NOTICE 'æƒ…æ„Ÿäº‹ä»¶è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    // æ­¥éª¤4: åˆ›å»ºè§‚ç‚¹åæ€è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_perspectives_table_step4',
      body: `
        -- åˆ›å»ºè§‚ç‚¹åæ€è¡¨
        CREATE TABLE IF NOT EXISTS perspectives (
          id SERIAL PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          event_id INTEGER REFERENCES emotional_events(id) ON DELETE CASCADE,
          content TEXT NOT NULL,
          perspective_type VARCHAR(20) NOT NULL CHECK (perspective_type IN ('reflection', 'insight', 'action')),
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºè§‚ç‚¹åæ€è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_perspectives_user_id ON perspectives(user_id);
        CREATE INDEX IF NOT EXISTS idx_perspectives_event_id ON perspectives(event_id);
        
        RAISE NOTICE 'è§‚ç‚¹åæ€è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    // æ­¥éª¤5: åˆ›å»ºé£Ÿè°±è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_recipes_table_step5',
      body: `
        -- åˆ›å»ºé£Ÿè°±è¡¨
        CREATE TABLE IF NOT EXISTS recipes (
          id SERIAL PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          name VARCHAR(100) NOT NULL,
          description TEXT,
          category VARCHAR(50),
          difficulty VARCHAR(10) CHECK (difficulty IN ('easy', 'medium', 'hard')),
          cooking_time INTEGER,
          ingredients JSONB,
          steps JSONB,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºé£Ÿè°±è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_recipes_user_id ON recipes(user_id);
        CREATE INDEX IF NOT EXISTS idx_recipes_category ON recipes(category);
        
        RAISE NOTICE 'é£Ÿè°±è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    // æ­¥éª¤6: åˆ›å»ºè®¢å•è¡¨
    await supabase.rpc('create_or_replace_function', {
      name: 'create_orders_table_step6',
      body: `
        -- åˆ›å»ºè®¢å•è¡¨
        CREATE TABLE IF NOT EXISTS meal_orders (
          id SERIAL PRIMARY KEY,
          user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
          recipe_id INTEGER REFERENCES recipes(id) ON DELETE CASCADE,
          scheduled_date DATE NOT NULL,
          servings INTEGER DEFAULT 1,
          notes TEXT,
          status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled')),
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        -- åˆ›å»ºè®¢å•è¡¨ç´¢å¼•
        CREATE INDEX IF NOT EXISTS idx_meal_orders_user_id ON meal_orders(user_id);
        CREATE INDEX IF NOT EXISTS idx_meal_orders_recipe_id ON meal_orders(recipe_id);
        CREATE INDEX IF NOT EXISTS idx_meal_orders_scheduled_date ON meal_orders(scheduled_date);
        
        RAISE NOTICE 'è®¢å•è¡¨åˆ›å»ºå®Œæˆ';
      `
    });

    console.log('âœ… æ‰€æœ‰RPCå‡½æ•°å®šä¹‰å®Œæˆï¼');
  } catch (error) {
    console.error('âŒ å®šä¹‰RPCå‡½æ•°æ—¶å‘ç”Ÿé”™è¯¯:', error);
  }
}

// æ‰§è¡Œè®¾ç½®
async function main() {
  console.log('ğŸš€ å¼€å§‹å®‰éš…APPæ•°æ®åº“è®¾ç½®æµç¨‹...\n');
  await defineRpcFunctions();
  await setupDatabase();
  console.log('\nâœ¨ æ•°æ®åº“è®¾ç½®æµç¨‹å®Œæˆï¼');
}

main();