# ç”¨æˆ·è®¤è¯ä¸æ•°æ®éš”ç¦»åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

å®Œæˆäº†å®‰éš…APPåç«¯æœåŠ¡çš„ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»åŠŸèƒ½ï¼Œç¡®ä¿ï¼š
1. æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
2. é€šè¿‡JWT tokenè¿›è¡Œèº«ä»½éªŒè¯
3. å‰ç«¯é€šè¿‡è¯·æ±‚å¤´ä¼ é€’tokenè¿›è¡Œè®¤è¯

## ğŸ“ æ–°å¢æ–‡ä»¶

### å·¥å…·å‡½æ•°
- `utils/jwt.js` - JWT tokenç”Ÿæˆå’ŒéªŒè¯å·¥å…·

### ä¸­é—´ä»¶
- `middleware/auth.js` - è®¤è¯ä¸­é—´ä»¶ï¼ˆåŒ…å«å¿…éœ€è®¤è¯ã€å¯é€‰è®¤è¯ã€ç®¡ç†å‘˜æƒé™éªŒè¯ï¼‰

### æµ‹è¯•æ–‡ä»¶
- `test-auth-isolation.js` - è®¤è¯å’Œæ•°æ®éš”ç¦»åŠŸèƒ½æµ‹è¯•è„šæœ¬

### æ–‡æ¡£
- `API-AUTH-DOCUMENTATION.md` - è¯¦ç»†çš„APIè®¤è¯æ–‡æ¡£

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### è·¯ç”±æ–‡ä»¶
- `routes/auth.js` - ä¿®æ”¹ç™»å½•æ¥å£è¿”å›JWT token
- `routes/anyu/bills.js` - æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»
- `routes/anyu/categories.js` - æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»
- `routes/anyu/statistics.js` - æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»
- `routes/anyu/emotional.js` - æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»
- `routes/anyu/mealPlans.js` - æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»

### é…ç½®æ–‡ä»¶
- `package.json` - æ·»åŠ jsonwebtokenä¾èµ–å’Œæµ‹è¯•è„šæœ¬

## ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. JWTè®¤è¯ç³»ç»Ÿ
```javascript
// ç”Ÿæˆtoken
const token = generateToken({
  userId: user.userId,
  username: user.username,
  role: user.role
});

// éªŒè¯token
const decoded = verifyToken(token);
```

### 2. è®¤è¯ä¸­é—´ä»¶
```javascript
// å¿…éœ€è®¤è¯
router.use(authenticate);

// å¯é€‰è®¤è¯
router.use(optionalAuth);

// ç®¡ç†å‘˜æƒé™
router.use(requireAdmin);
```

### 3. æ•°æ®éš”ç¦»æœºåˆ¶
æ‰€æœ‰anyuæ¨¡å—çš„æŸ¥è¯¢éƒ½æ·»åŠ äº†ç”¨æˆ·IDè¿‡æ»¤ï¼š
```javascript
.eq('user_id', req.user.userId)
```

### 4. è‡ªåŠ¨æ•°æ®å…³è”
åˆ›å»ºæ•°æ®æ—¶è‡ªåŠ¨å…³è”å½“å‰ç”¨æˆ·ï¼š
```javascript
user_id: req.user.userId
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•
```bash
npm run test:auth
```

### æµ‹è¯•åœºæ™¯
1. âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•åŠŸèƒ½
2. âœ… JWT tokenç”Ÿæˆå’ŒéªŒè¯
3. âœ… æ— è®¤è¯è®¿é—®æ‹¦æˆª
4. âœ… ç”¨æˆ·æ•°æ®éš”ç¦»éªŒè¯
5. âœ… è·¨ç”¨æˆ·æ•°æ®è®¿é—®é˜²æŠ¤

## ğŸ“‹ APIå˜æ›´

### ç™»å½•å“åº”æ ¼å¼æ›´æ–°
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": "ç”¨æˆ·ID",
    "username": "ç”¨æˆ·å", 
    "avatar_url": "å¤´åƒé“¾æ¥",
    "role": "ç”¨æˆ·è§’è‰²",
    "token": "JWT_TOKEN_HERE"
  }
}
```

### è¯·æ±‚å¤´æ ¼å¼
```
Authorization: Bearer JWT_TOKEN_HERE
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. æ•°æ®éš”ç¦»
- æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- ç³»ç»Ÿçº§è‡ªåŠ¨è¿‡æ»¤ï¼Œæ— éœ€å‰ç«¯å¤„ç†

### 2. æƒé™æ§åˆ¶
- å¿…éœ€è®¤è¯ï¼šæ•æ„Ÿæ•°æ®æ“ä½œ
- å¯é€‰è®¤è¯ï¼šå…¬å¼€æ•°æ®è®¿é—®
- ç®¡ç†å‘˜æƒé™ï¼šç‰¹æ®Šç®¡ç†åŠŸèƒ½

### 3. é”™è¯¯å¤„ç†
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- å®‰å…¨çš„æ—¥å¿—è®°å½•

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### å‰ç«¯é›†æˆè¦ç‚¹

1. **ç™»å½•è·å–token**
```javascript
const response = await fetch('/api/auth/login', {
  method: 'POST',
  body: JSON.stringify({ username, password })
});
const result = await response.json();
localStorage.setItem('authToken', result.data.token);
```

2. **æºå¸¦tokenè®¿é—®API**
```javascript
const token = localStorage.getItem('authToken');
fetch('/api/anyu/bills', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

3. **å¤„ç†è®¤è¯å¤±è´¥**
```javascript
if (response.status === 401) {
  localStorage.removeItem('authToken');
  // è·³è½¬åˆ°ç™»å½•é¡µ
}
```

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡é…ç½®
```env
JWT_SECRET=your-super-secret-jwt-key-here
```

### ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
1. ä½¿ç”¨å¼ºéšæœºçš„JWTå¯†é’¥
2. è®¾ç½®åˆé€‚çš„tokenè¿‡æœŸæ—¶é—´
3. å®æ–½tokenåˆ·æ–°æœºåˆ¶
4. å¯ç”¨HTTPS
5. é…ç½®é€‚å½“çš„CORSç­–ç•¥

## ğŸ“Š æ€§èƒ½å½±å“

- è®¤è¯éªŒè¯å¢åŠ çº¦1-2mså¤„ç†æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢å¢åŠ user_idè¿‡æ»¤æ¡ä»¶
- å†…å­˜ä½¿ç”¨ç•¥æœ‰å¢åŠ ï¼ˆtokenå­˜å‚¨ï¼‰
- æ•´ä½“æ€§èƒ½å½±å“å¯å¿½ç•¥ä¸è®¡

## ğŸ‰ æˆæœæ€»ç»“

âœ… **å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ** - JWT tokenæœºåˆ¶  
âœ… **ä¸¥æ ¼çš„æ•°æ®éš”ç¦»** - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®  
âœ… **å…¨é¢çš„å®‰å…¨é˜²æŠ¤** - å¤šå±‚æ¬¡æƒé™æ§åˆ¶  
âœ… **è‰¯å¥½çš„å¼€å‘è€…ä½“éªŒ** - æ¸…æ™°çš„APIæ–‡æ¡£å’Œé”™è¯¯ä¿¡æ¯  
âœ… **å……åˆ†çš„æµ‹è¯•è¦†ç›–** - è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§  

è¿™ä¸ªå®ç°åœ¨ä¿è¯å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¸ºå‰ç«¯æä¾›äº†ç®€å•æ˜“ç”¨çš„è®¤è¯æ¥å£ï¼Œå®Œå…¨æ»¡è¶³äº†é¡¹ç›®çš„éœ€æ±‚ã€‚